#include<stdio.h>
#include<stdlib.h>
#include<math.h>
#include<windows.h>

//???Z?b?g
const char h0 = 0x00; //0(10) h0 ???Z?b?g?p
//?w?b?_
const char h1 = 0xFF; //255(10)?@h1?`h5 ?w?b?_?p
const char h2 = 0x92; //146(10)
const char h3 = 0x00; //0(10)
const char h4 = 0xC0; //192(10)
const char h5 = 0x00; //0(10)

HANDLE hComm; //?V???A???|?[?g??n???h??
DWORD writesize; //?|?[?g?????????o?C?g??


//??M??g??USB?|?[?g??I??
int _SelectPort(char portname[])
{
	int num = 1;
	int cnt = 0;
	int i;
	int j;
	char portname1[100];
	char portname2[10][100];
	char port_num[10];

	while (num > 0 && num < 10){
		sprintf(port_num, "%d", num);
		strcpy(portname1, "COM");
		strcat(portname1, port_num);

		hComm = CreateFile(
			portname1,
			0,
			0,
			NULL,
			OPEN_EXISTING,
			FILE_ATTRIBUTE_NORMAL,
			NULL
			);

		if (hComm == INVALID_HANDLE_VALUE){
			CloseHandle(hComm);
		}
		else{
			printf("%s ????ł?????B\n", portname1);
			CloseHandle(hComm);
			strcpy(portname2[cnt], portname1);
			cnt++;
		}
		num++;
	}

	if (cnt == 0){
		printf("????ł???|?[?g?????????????B");
		getchar();
		exit(1);
	}
	else if (cnt == 1){
		strcpy(portname, portname2[0]);
		printf("\n%s????????????B", portname);
	}
	else{
		printf("\n??????|?[?g??????????????B???????|?[?g??I?????Ă????????B\n");

		for (i = 0; i < cnt; i++){
			printf("%d.%s ", i + 1, portname2[i]);
		}
		do{
			printf("\n????őI??:");
			scanf("%d", &i);
		} while (i < 1 || i > cnt);

		strcpy(portname, portname2[i - 1]);
		printf("\n%s????????????B\n", portname);
	}
	return 0;
}

int _OpenHandle(char portname[])
{

?@?@?@//??M????????
	hComm = CreateFile(
		portname,
		GENERIC_WRITE,
		0,
		NULL,
		CREATE_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
		);

	DCB dcb;
	GetCommState(hComm, &dcb);
	dcb.BaudRate = 38400;
	dcb.ByteSize = 8;
	dcb.Parity = NOPARITY;
	dcb.StopBits = ONESTOPBIT;
	SetCommState(hComm, &dcb);
	return 0;

}

void _init()
{
	//?w?b?_?????
	WriteFile(hComm, &h1, 1, &writesize, NULL);
	WriteFile(hComm, &h1, 1, &writesize, NULL);
	WriteFile(hComm, &h2, 1, &writesize, NULL);
	WriteFile(hComm, &h3, 1, &writesize, NULL);
	WriteFile(hComm, &h4, 1, &writesize, NULL);
	WriteFile(hComm, &h5, 1, &writesize, NULL);
}

int main(void)
{

	int x = 0; //?s????s???
	int y = 0; //?s???????
	int qy;	//y???quotient	
	int my;	//????]??mod
	int i = 0; //?s???????(1?o?C?g?ϊ???????)
	int j = 0; //?s????s???(1?o?C?g?ϊ???????)
	int val; //????????l?????I??u??
	int cnt = 0; //????????l??z????
	int csvData[1536] = {}; //????????l
	int pin[32][48] = {}; //?s??????l
	int pin_1byte[4][48] = {}; //?s??????l??1?o?C?g?????ϊ?
	char portname[100];//??M??g???|?[?g
	char output_char[256];//?o???????
	char filename[256];//?t?@?C??????O
	char filepath[256] = "?f?[?^????t?@?C??/";//?t?@?C???????p?X
	FILE *fp = NULL;



	_SelectPort(portname);

	_OpenHandle(portname);


	while (1){


		do{
			printf("?\???????????????????Ă???????(?I???????0?????):");
			scanf("%s", &output_char);
			getchar();


			if (strcmp(output_char, "0") == 0 || strcmp(output_char, "?O") == 0) {

				//?S?Ă?s????0??M
				_init();
				for (i = 0; i < 4; i++) {
					for (j = 0; j < 48; j++) {
						WriteFile(hComm, &h0, 1, &writesize, NULL);
					}
				}
				printf("?I????????B");
				getchar();
				CloseHandle(hComm);
				return 0;
			}


			else{
				//??????????t?@?C????????
				strcat(output_char, ".csv");
				strcpy(filename, filepath);
				strcat(filename, output_char);

				fopen_s(&fp, filename, "r");

				//?G???[????
				if (fp == NULL) {
					printf("?t?@?C???????????????B??????x??????Ă????????B\n");
				}
			}
		} while (fp == NULL);

		//CSV?t?@?C???????l???????
		while (fscanf(fp, "%d,", &val) != EOF){
			//?f?[?^??0??O??????S??1??ς???
			if (val != 0){
				val = 1;
			}
			csvData[cnt] = val;
			cnt++;
		}

		cnt = 0;
		fclose(fp);

		//????????l???s???z?????
		for (y = 0; y < 32; y++){
			for (x = 0; x < 48; x++){
				pin[y][x] = csvData[cnt];
				cnt++;


				//???s??????f????\??
				if (pin[y][x] == 0){
					printf("  ");
				}
				else{
					printf("??");
				}
			}
			printf("\n");
		}

		cnt = 0;

		_init();

		//?f?[?^??1?o?C?g????????
		for (y = 0; y < 32; y++) {
			for (x = 0; x < 48; x++) {
				qy = y / 8;
				my = y % 8;
				pin_1byte[qy][x] += pin[y][x] * pow(2.0, my);
			}
		}

		//?f?[?^???M
		for (i = 0; i < 4; i++) {
			for (j = 0; j < 48; j++) {
				WriteFile(hComm, &pin_1byte[i][j], 1, &writesize, NULL);
				pin_1byte[i][j] = 0;
			}
		}
	}

}
